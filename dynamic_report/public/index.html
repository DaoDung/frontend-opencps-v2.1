<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <link rel="icon" href="<%= BASE_URL %>favicon.ico">
  <link href='https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Material+Icons' rel="stylesheet" type="text/css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <title>bbat</title>
</head>

<body>
  <noscript>
    <strong>We're sorry but bbat doesn't work properly without JavaScript enabled. Please enable it to continue.</strong>
  </noscript>
  <div id="app"></div>
  <!-- built files will be auto injected -->
  <div style="border:1px solid">
    <div id="drop">
      <span>Drop PDF file here</span>
    </div>
    <span>or click </span>
    <input type="file" id="pdf-file" />
  </div>

  <h2>HTML Result:</h2>
  <div id="html-result"></div>

  <script src="build/pdf.js"></script>
  <script src="pdf-table-extractor.js"></script>
  <script id="script">

    var drop = document.getElementById('drop');
    function handleDrop(e) {
      e.stopPropagation();
      e.preventDefault();
      var files = e.dataTransfer.files;
      var f = files[0];
      {
        var reader = new FileReader();
        var name = f.name;
        reader.onload = function (e) {
          var data = e.target.result;
          parse_content(data); //btoa(arr));
        };
        reader.readAsArrayBuffer(f);
      }
    }

    function handleFile(e) {
      var files = e.target.files;
      var f = files[0];
      {
        var reader = new FileReader();
        var name = f.name;
        reader.onload = function (e) {
          var data = e.target.result;
          console.log('data', data)
          parse_content(data); //btoa(arr));
        };
        reader.readAsArrayBuffer(f);
      }
    }
    document.getElementById('pdf-file').addEventListener('change', handleFile, false);


    function handleDragover(e) {
      e.stopPropagation();
      e.preventDefault();
      e.dataTransfer.dropEffect = 'copy';
    }

    if (drop.addEventListener) {
      drop.addEventListener('dragenter', handleDragover, false);
      drop.addEventListener('dragover', handleDragover, false);
      drop.addEventListener('drop', handleDrop, false);
    }


    //
    // If absolute URL from the remote server is provided, configure the CORS
    // header on that server.
    //

    var array_to_csv = function (tables) {
      return tables.map(function (rows) {
        return rows.map(function (v) {
          if ('undefined' === typeof (v) || v === null) {
            return v;
          }
          if (v.indexOf('"')) {
            v = v.replace(/"/g, '""');
          }
          if (v.indexOf('"') >= 0 || v.indexOf("\n") >= 0 || v.indexOf(",") >= 0) {
            v = '"' + v + '"';
          }
          return v;
        }).join(',');
      }).join("\n");
    };

    var parse_content = function (content) {
      console.log(content)

      PDFJS.workerSrc = 'build/pdf.worker.js';
      PDFJS.getDocument(content).then(pdf_table_extractor).then(function (result) {


        console.log('result PDFJS', result.pageTables)
        // JSON output
        $('#html-result').html('');

        var all_tables = [];
        var pageTablesData = result.pageTables.shift()
        console.log(pageTablesData)
          if (!$('input:checkbox[name="merge-table"]').is(':checked') && !$('input:checkbox[name="merge-table-remove-first-line"]').is(':checked')) {
            $('#html-result').append($('<h3></h3>').text('Page ' + pageTablesData.page));
          }

          if ($('input:checkbox[name="merge-table-remove-first-line"]').is(':checked') && pageTablesData.page > 1) {
            all_tables = all_tables.concat(pageTablesData.tables.slice(1));
          } else {
            all_tables = all_tables.concat(pageTablesData.tables);
          }
          table_dom = $('<table></table>').attr('border', 1);
          var tables = pageTablesData.tables;
          var merge_alias = pageTablesData.merge_alias;
          var merges = pageTablesData.merges;

          for (var r = 0; r < tables.length; r++) {
            if ($('input:checkbox[name="merge-table-remove-first-line"]').is(':checked') && pageTablesData.page != 1 && r == 0) {
              continue;
            }
            tr_dom = $('<tr></tr>');
            for (var c = 0; c < tables[r].length; c++) {
              r_c = [r, c].join('-');
              if (merge_alias[r_c]) {
                continue;
              }

              td_dom = $('<td></td>');
              if (merges[r_c]) {
                if (merges[r_c].width > 1) {
                  td_dom.attr('colspan', merges[r_c].width);
                }
                if (merges[r_c].height > 1) {
                  td_dom.attr('rowspan', merges[r_c].height);
                }
              }
              td_dom.text(tables[r][c]);
              tr_dom.append(td_dom);
            }
            table_dom.append(tr_dom);
          }
          $('#html-result').append(table_dom);
      });
    };
  </script>

</body>

</html>